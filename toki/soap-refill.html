<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pearl Soap 補充 | トキストレージ</title>
    <meta name="description" content="Pearl Soapをご利用いただきありがとうございます。補充のご案内ページです。">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;700&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <style>
        .refill-page {
            padding: 4rem 2rem;
            min-height: 100vh;
        }
        .refill-inner {
            max-width: 480px;
            margin: 0 auto;
            text-align: center;
        }
        .refill-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }
        .refill-inner h1 {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .refill-thanks {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.8;
        }
        .refill-card {
            background: var(--bg-page);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }
        .refill-card h2 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }
        .refill-card p {
            font-size: 0.88rem;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 1rem;
            text-align: center;
        }
        .refill-btn {
            display: block;
            width: 100%;
            background: var(--toki-blue);
            color: #fff;
            padding: 0.9rem 2rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background 0.3s ease;
            margin-top: 1rem;
            border: none;
            cursor: pointer;
            text-align: center;
        }
        .refill-btn:hover {
            background: var(--toki-blue-dark);
        }
        .refill-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        .refill-btn-secondary {
            background: transparent;
            color: var(--toki-blue);
            border: 1px solid var(--toki-blue);
        }
        .refill-btn-secondary:hover {
            background: var(--toki-blue-pale);
        }

        /* ステップ表示 */
        .step { display: none; }
        .step.active { display: block; }

        /* 地図 */
        #map {
            height: 200px;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        /* 住所表示 */
        .address-display {
            background: var(--bg-section);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.88rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* フォーム */
        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.4rem;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 0.4rem;
            font-size: 0.88rem;
            font-family: inherit;
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--toki-blue);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ローディング */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 完了画面 */
        .complete-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .refill-features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }
        .refill-feature {
            background: var(--bg-page);
            border: 1px solid var(--border);
            border-radius: 0.8rem;
            padding: 1rem 0.8rem;
            text-align: center;
        }
        .refill-feature .feature-icon {
            font-size: 1.4rem;
            margin-bottom: 0.4rem;
        }
        .refill-feature h3 {
            font-family: var(--font-display);
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }
        .refill-feature p {
            font-size: 0.68rem;
            color: var(--text-muted);
            line-height: 1.5;
            margin: 0;
        }
        .refill-note {
            font-size: 0.78rem;
            color: var(--text-muted);
            line-height: 1.7;
            margin-top: 1.5rem;
            text-align: center;
        }
        .refill-links {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            text-align: center;
        }
        .refill-links a {
            display: inline-block;
            color: var(--toki-blue);
            text-decoration: none;
            font-size: 0.85rem;
            margin: 0.3rem 0.8rem;
        }
        .refill-links a:hover {
            text-decoration: underline;
        }
        .skip-link {
            display: block;
            margin-top: 1rem;
            font-size: 0.82rem;
            color: var(--text-muted);
            text-decoration: underline;
            cursor: pointer;
            background: none;
            border: none;
        }
        .error-message {
            color: #c53030;
            font-size: 0.82rem;
            margin-top: 0.5rem;
        }
        @media (max-width: 480px) {
            .refill-features {
                grid-template-columns: 1fr;
            }
            .refill-page {
                padding: 3rem 1.5rem;
            }
        }
    </style>
</head>
<body>

<nav class="toki-nav">
    <span class="nav-logo"><a href="index.html">トキストレージ</a> / Pearl Soap</span>
</nav>

<main class="refill-page">
    <div class="refill-inner">
        <div class="refill-icon">&#x1F43E;</div>
        <h1>ご利用いただき<br>ありがとうございます</h1>
        <p class="refill-thanks">
            Pearl Soapをお使いいただき、<br>
            心より感謝申し上げます。
        </p>

        <!-- Step 1: 位置情報取得 -->
        <div class="refill-card step active" id="step1">
            <h2>Pearl Soapの補充</h2>
            <p>石鹸がなくなりましたら、<br>補充をご依頼ください。<br>ギフトエコノミーとして、<br>無料でお届けいたします。</p>

            <button class="refill-btn" id="getLocationBtn" onclick="getLocation()">
                現在地からお届け先を設定
            </button>
            <button class="skip-link" onclick="showManualForm()">
                住所を直接入力する
            </button>
        </div>

        <!-- Step 2: 位置確認 -->
        <div class="refill-card step" id="step2">
            <h2>お届け先の確認</h2>
            <p>この場所にお届けしてよろしいですか？</p>

            <div id="map"></div>
            <div class="address-display" id="addressDisplay"></div>

            <button class="refill-btn" onclick="confirmLocation()">
                この場所でOK
            </button>
            <button class="refill-btn refill-btn-secondary" onclick="showManualForm()">
                住所を修正する
            </button>
        </div>

        <!-- Step 3: 手動入力フォーム -->
        <div class="refill-card step" id="step3">
            <h2>お届け先の入力</h2>

            <form id="refillForm" onsubmit="submitForm(event)">
                <div class="form-group">
                    <label for="name">お名前</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="postal">郵便番号</label>
                    <input type="text" id="postal" name="postal" placeholder="000-0000">
                </div>
                <div class="form-group">
                    <label for="address">ご住所</label>
                    <textarea id="address" name="address" required placeholder="都道府県から入力してください"></textarea>
                </div>
                <div class="form-group">
                    <label for="message">メッセージ（任意）</label>
                    <textarea id="message" name="message" placeholder="何かあればお気軽にどうぞ"></textarea>
                </div>

                <input type="hidden" id="lat" name="lat">
                <input type="hidden" id="lng" name="lng">

                <button type="submit" class="refill-btn">補充を依頼する</button>
            </form>
        </div>

        <!-- Step 4: 完了 -->
        <div class="refill-card step" id="step4">
            <div class="complete-icon">&#x2728;</div>
            <h2>ありがとうございます</h2>
            <p>補充のご依頼を受け付けました。<br>準備ができ次第、お届けいたします。</p>
            <p style="font-size: 0.78rem; color: var(--text-muted);">通常1〜2週間ほどでお届けします。</p>
        </div>

        <div class="refill-features">
            <div class="refill-feature">
                <div class="feature-icon">&#x1F43E;</div>
                <h3>肉球デザイン</h3>
                <p>手のひらで大切な存在を思い出す</p>
            </div>
            <div class="refill-feature">
                <div class="feature-icon">&#x1F334;</div>
                <h3>ココナッツ</h3>
                <p>優しい香りの手作り石鹸</p>
            </div>
            <div class="refill-feature">
                <div class="feature-icon">&#x1F381;</div>
                <h3>ギフト</h3>
                <p>感謝を形にする贈りもの</p>
            </div>
        </div>

        <p class="refill-note">
            Pearl Soapは販売品ではありません。<br>
            「いてくれてありがとう」の想いを込めて、<br>
            ご縁のある方への贈りものとしてお届けしています。
        </p>

        <div class="refill-links">
            <a href="pearl-soap.html">Pearl Soapについて</a>
            <a href="index.html">トキストレージとは</a>
        </div>
    </div>
</main>

<footer class="toki-footer" style="background: var(--bg-page); padding: 1.5rem;">
    <div style="text-align: center;">
        <p style="font-size: 0.75rem; color: var(--text-muted);">&copy; 2026 トキストレージ / Universal Need株式会社</p>
    </div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
    let map = null;
    let marker = null;
    let currentLat = null;
    let currentLng = null;
    let currentAddress = null;

    // ステップ切り替え
    function showStep(stepNum) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById('step' + stepNum).classList.add('active');
    }

    // 位置情報取得
    function getLocation() {
        const btn = document.getElementById('getLocationBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span>位置情報を取得中...';

        if (!navigator.geolocation) {
            alert('お使いのブラウザは位置情報に対応していません。');
            btn.disabled = false;
            btn.textContent = '現在地からお届け先を設定';
            return;
        }

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;

                // 逆ジオコーディング
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLng}&accept-language=ja`
                    );
                    const data = await response.json();
                    currentAddress = formatAddress(data);
                } catch (e) {
                    currentAddress = `緯度: ${currentLat.toFixed(6)}, 経度: ${currentLng.toFixed(6)}`;
                }

                // 地図表示
                showStep(2);
                initMap(currentLat, currentLng);
                document.getElementById('addressDisplay').textContent = currentAddress;
            },
            (error) => {
                btn.disabled = false;
                btn.textContent = '現在地からお届け先を設定';

                let message = '位置情報を取得できませんでした。';
                if (error.code === error.PERMISSION_DENIED) {
                    message = '位置情報の許可が必要です。住所を直接入力してください。';
                }
                alert(message);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    // 住所フォーマット
    function formatAddress(data) {
        const addr = data.address || {};
        const parts = [];

        if (addr.postcode) parts.push('〒' + addr.postcode);
        if (addr.province || addr.state) parts.push(addr.province || addr.state);
        if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
        if (addr.suburb || addr.neighbourhood) parts.push(addr.suburb || addr.neighbourhood);
        if (addr.road) parts.push(addr.road);
        if (addr.house_number) parts.push(addr.house_number);

        return parts.length > 0 ? parts.join(' ') : data.display_name || '住所を取得できませんでした';
    }

    // 地図初期化
    function initMap(lat, lng) {
        if (map) {
            map.remove();
        }

        map = L.map('map').setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        marker = L.marker([lat, lng]).addTo(map);

        // 地図サイズ調整
        setTimeout(() => map.invalidateSize(), 100);
    }

    // 位置確定
    function confirmLocation() {
        document.getElementById('lat').value = currentLat;
        document.getElementById('lng').value = currentLng;
        document.getElementById('address').value = currentAddress.replace('〒', '').trim();

        // 郵便番号を抽出
        const postalMatch = currentAddress.match(/〒?(\d{3}-?\d{4})/);
        if (postalMatch) {
            document.getElementById('postal').value = postalMatch[1];
        }

        showStep(3);
    }

    // 手動入力フォーム表示
    function showManualForm() {
        showStep(3);
    }

    // フォーム送信
    async function submitForm(event) {
        event.preventDefault();

        const form = document.getElementById('refillForm');
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span>送信中...';

        const formData = {
            name: document.getElementById('name').value,
            postal: document.getElementById('postal').value,
            address: document.getElementById('address').value,
            message: document.getElementById('message').value,
            lat: document.getElementById('lat').value,
            lng: document.getElementById('lng').value,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
        };

        try {
            // Google Apps Script Web App にPOST
            // ↓↓↓ デプロイ後のURLに置き換えてください ↓↓↓
            const endpoint = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
            // ↑↑↑ デプロイ後のURLに置き換えてください ↑↑↑

            console.log('送信データ:', formData);

            // エンドポイントが設定されている場合のみ送信
            if (!endpoint.includes('YOUR_SCRIPT_ID')) {
                await fetch(endpoint, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
            } else {
                console.warn('GASエンドポイントが未設定です。gas/soap-refill-receiver.gs を参照してください。');
            }

            // 完了画面表示
            showStep(4);
        } catch (error) {
            console.error('送信エラー:', error);
            alert('送信に失敗しました。もう一度お試しください。');
            submitBtn.disabled = false;
            submitBtn.textContent = '補充を依頼する';
        }
    }
</script>

</body>
</html>
